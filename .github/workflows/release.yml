name: Release (multi-mod) + Workshop + Changelogs

permissions:
  contents: read

on:
  push:
    branches: ["main"]
    paths:
      - "*.zip"
  workflow_dispatch:
    inputs:
      zips:
        description: "Optional: release only these zips (comma-separated paths). Example: export/TajemnikTV-Core. zip,export/TajemnikTV-QoL.zip"
        required: false
        default: ""

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      zips_json: ${{ steps.detect.outputs.zips_json }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Detect changed ZIPs
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          if [ -n "${{ github.event. inputs.zips }}" ]; then
            # Manual selection
            RAW="${{ github.event.inputs.zips }}"
            ZIPS="$(printf "%s" "$RAW" | tr ',' '\n' | sed 's/^[[:space:]]*//; s/[[:space:]]*$//' | sed '/^$/d')"
          else
            BEFORE="${{ github.event.before }}"
            SHA="${{ github.sha }}"

            if [ -z "$BEFORE" ] || [[ "$BEFORE" =~ ^0{40}$ ]]; then
              # First push / no before SHA - list files in the commit
              CHANGED="$(git show --pretty='' --name-only "$SHA" || true)"
            else
              CHANGED="$(git diff --name-only "$BEFORE" "$SHA" || true)"
            fi

            # Prefer export/*. zip if present, fallback to root zips
            ZIPS="$(printf "%s\n" "$CHANGED" | grep -E '^export/[^/]+\. zip$' || true)"
            if [ -z "$ZIPS" ]; then
              ZIPS="$(printf "%s\n" "$CHANGED" | grep -E '^[^/]+\.zip$' || true)"
            fi
          fi

          if [ -z "${ZIPS:-}" ]; then
            echo "No changed ZIP files detected."
            echo 'zips_json=[]' >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Ensure they exist in workspace (tracked files)
          OK_LIST=""
          while IFS= read -r z; do
            [ -n "$z" ] || continue
            if [ -f "$z" ]; then
              OK_LIST="${OK_LIST}"$'\n'"$z"
            else
              echo "Warning: ZIP not found in checkout: $z"
            fi
          done <<< "$ZIPS"

          OK_LIST="$(printf "%s" "$OK_LIST" | sed '/^$/d')"
          if [ -z "$OK_LIST" ]; then
            echo 'zips_json=[]' >> "$GITHUB_OUTPUT"
            exit 0
          fi

          ZIPS_JSON="$(printf "%s\n" "$OK_LIST" | jq -R -s -c 'split("\n") | map(select(length>0))')"
          echo "zips_json=$ZIPS_JSON" >> "$GITHUB_OUTPUT"

  prep:
    runs-on: ubuntu-latest
    needs: [detect]
    permissions:
      contents: write
    outputs:
      mods_json: ${{ steps.prep.outputs.mods_json }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install tools
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq unzip

      - name: Validate workshop_map.json exists
        shell: bash
        run: |
          set -euo pipefail
          test -f workshop_map.json || (echo "Missing workshop_map.json in repo root" && exit 1)

      - name: Prepare per-mod metadata + changelog + notes
        id: prep
        shell: bash
        run: |
          set -euo pipefail

          ZIPS_JSON='${{ needs.detect.outputs.zips_json }}'
          if [ "$ZIPS_JSON" = "[]" ] || [ -z "$ZIPS_JSON" ]; then
            echo 'mods_json=[]' >> "$GITHUB_OUTPUT"
            exit 0
          fi

          mkdir -p changelogs
          TODAY="$(date +%F)"

          MODS='[]'

          # Iterate zips
          while IFS= read -r ZIP; do
            [ -n "$ZIP" ] || continue
            test -f "$ZIP" || (echo "Missing ZIP: $ZIP" && exit 1)

            # Find manifest. json inside the zip
            MANIFEST_PATH="$(unzip -Z1 "$ZIP" | grep -Ei '(^|/)(manifest\.json)$' | head -n 1 || true)"
            test -n "$MANIFEST_PATH" || (echo "No manifest.json found inside $ZIP" && exit 1)

            MANIFEST_JSON="$(unzip -p "$ZIP" "$MANIFEST_PATH" || true)"
            test -n "$MANIFEST_JSON" || (echo "Failed reading manifest.json from $ZIP" && exit 1)

            NAMESPACE="$(printf "%s" "$MANIFEST_JSON" | jq -r '.namespace // empty')"
            NAME="$(printf "%s" "$MANIFEST_JSON" | jq -r '.name // empty')"
            VER="$(printf "%s" "$MANIFEST_JSON" | jq -r '.version_number // empty')"

            test -n "$NAME" || (echo "manifest.json missing . name in $ZIP" && exit 1)
            test -n "$VER"  || (echo "manifest.json missing .version_number in $ZIP" && exit 1)

            if [ -n "$NAMESPACE" ]; then MOD_ID="${NAMESPACE}-${NAME}"; else MOD_ID="${NAME}"; fi
            SAFE_ID="$(echo "$MOD_ID" | tr ' ' '-' | tr -cd '[:alnum:]._-' )"

            TAG="${SAFE_ID}-v${VER}"
            TITLE="${SAFE_ID} v${VER}"
            ASSET_NAME="${SAFE_ID}-v${VER}.zip"

            # Steam mapping
            PUBLISHED_FILE_ID="$(jq -r --arg id "$SAFE_ID" '.[$id].publishedFileId // empty' workshop_map.json)"
            APP_ID="$(jq -r --arg id "$SAFE_ID" '.[$id].appId // "3606890"' workshop_map.json)"

            test -n "$PUBLISHED_FILE_ID" || (echo "workshop_map.json missing publishedFileId for key:  $SAFE_ID" && exit 1)

            # Changelog file per mod
            CHANGELOG="changelogs/${SAFE_ID}. md"
            if [ !  -f "$CHANGELOG" ]; then
              {
                echo "# Changelog â€” ${SAFE_ID}"
                echo
              } > "$CHANGELOG"
            fi

            # Extract existing section for this version (if present)
            EXISTING="$(awk -v ver="$VER" '
              BEGIN {found=0}
              $0 ~ "^##[[:space:]]*\\[" ver "\\][[:space:]]*-" {found=1; next}
              found && $0 ~ "^##[[: space:]]*\\[[0-9]" {exit}
              found {print}
            ' "$CHANGELOG" || true)"

            NONEMPTY="$(printf "%s\n" "$EXISTING" \
              | sed '/^[[:space:]]*$/d' \
              | grep -E '^- ' -m 1 || true)"

            NEEDS_GEN="false"
            if !  grep -qE "^##[[:space:]]*\\[$VER\\][[:space:]]*-" "$CHANGELOG"; then
              NEEDS_GEN="true"
            elif [ -z "$NONEMPTY" ]; then
              NEEDS_GEN="true"
            fi

            NOTES=""
            if [ "$NEEDS_GEN" = "true" ]; then
              echo "Changelog for $SAFE_ID [$VER] missing/blank -> creating template for manual editing..."

              # Create simple template
              NOTES="
                ### Added
                - N/A or TBD

                ### Changed
                - N/A or TBD 

                ### Removed
                - N/A or TBD

                ### Fixed
                - N/A or TBD
                "

              # Prepend new entry
              {
                echo "## [$VER] - $TODAY"
                echo
                printf "%s\n" "$NOTES"
                echo
                cat "$CHANGELOG"
              } > "${CHANGELOG}.new"
              mv "${CHANGELOG}.new" "$CHANGELOG"
            else
              echo "Changelog for $SAFE_ID [$VER] exists -> using existing."
              NOTES="$EXISTING"
            fi

            STEAM_NOTE="$(printf "%s" "$NOTES" | head -c 7000)"

            NOTES_B64="$(printf "%s" "$NOTES" | base64 -w0)"
            STEAM_B64="$(printf "%s" "$STEAM_NOTE" | base64 -w0)"

            MODS="$(jq -c \
              --arg zip "$ZIP" \
              --arg safe_id "$SAFE_ID" \
              --arg ver "$VER" \
              --arg tag "$TAG" \
              --arg title "$TITLE" \
              --arg asset "$ASSET_NAME" \
              --arg notes_b64 "$NOTES_B64" \
              --arg steam_b64 "$STEAM_B64" \
              --arg app_id "$APP_ID" \
              --arg published "$PUBLISHED_FILE_ID" \
              '. + [{
                zip_path: $zip,
                safe_id: $safe_id,
                version:  $ver,
                tag: $tag,
                title: $title,
                asset_name: $asset,
                notes_b64: $notes_b64,
                steam_note_b64: $steam_b64,
                appId: $app_id,
                publishedFileId: $published
              }]' <<< "$MODS")"

          done < <(jq -r '. []' <<< "$ZIPS_JSON")

          echo "mods_json=$MODS" >> "$GITHUB_OUTPUT"

      - name: Commit changelogs (if changed)
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "docs: update per-mod changelogs"
          file_pattern: changelogs/*.md

  github_release:
    runs-on: ubuntu-latest
    needs: [prep]
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        mod: ${{ fromJson(needs.prep.outputs.mods_json) }}
    steps:
      - uses: actions/checkout@v6

      - name: Create/Update GitHub Release + upload asset
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          ZIP="${{ matrix.mod.zip_path }}"
          test -f "$ZIP" || (echo "Missing ZIP: $ZIP" && exit 1)

          TAG="${{ matrix.mod.tag }}"
          TITLE="${{ matrix.mod. title }}"
          ASSET_NAME="${{ matrix.mod.asset_name }}"

          NOTES="$(printf "%s" "${{ matrix.mod.notes_b64 }}" | base64 -d)"

          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release upload "$TAG" "${ZIP}#${ASSET_NAME}" --clobber
            gh release edit "$TAG" --title "$TITLE" --notes "$NOTES"
          else
            gh release create "$TAG" "${ZIP}#${ASSET_NAME}" \
              --title "$TITLE" \
              --notes "$NOTES" \
              --target "$GITHUB_SHA"
          fi

  steam_workshop:
    runs-on: ubuntu-latest
    needs: [prep, github_release]
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mod: ${{ fromJson(needs.prep.outputs.mods_json) }}
    steps:
      - uses: actions/checkout@v6

      - name: Decode Steam change note
        shell: bash
        run: |
          set -euo pipefail
          NOTE="$(printf "%s" "${{ matrix.mod.steam_note_b64 }}" | base64 -d | tr -d '\r')"
          DELIM="EOF_$(date +%s%N)"
          {
            echo "CHANGE_NOTE<<$DELIM"
            printf '%s\n' "$NOTE"
            echo "$DELIM"
          } >> "$GITHUB_ENV"

      - name: Stage Workshop payload (zip only)
        env:
          STEAM_USERNAME: ${{ secrets.STEAM_USERNAME }}
        shell: bash
        run: |
          set -euo pipefail

          rm -rf workshop_upload
          mkdir -p workshop_upload

          ZIP="${{ matrix.mod.zip_path }}"
          ASSET_NAME="${{ matrix.mod.asset_name }}"

          test -f "$ZIP" || (echo "Missing ZIP: $ZIP" && exit 1)
          cp "$ZIP" "workshop_upload/$ASSET_NAME"

          echo "Staged:"
          ls -la workshop_upload

      - name: Upload to Steam Workshop (steamcmd)
        uses: m00nl1ght-dev/steam-workshop-deploy@v4
        with:
          username: ${{ secrets.STEAM_USERNAME }}
          configVdf: ${{ secrets.STEAM_CONFIG_VDF }}
          path: workshop_upload
          appId: ${{ matrix.mod.appId }}
          publishedFileId: ${{ matrix.mod.publishedFileId }}
          changeNote: ${{ env.CHANGE_NOTE }}
